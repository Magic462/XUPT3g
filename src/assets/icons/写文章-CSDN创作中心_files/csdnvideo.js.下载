(function(){var h=null,g="csdnvideo",e=1,k=!1,n=!1;CKEDITOR.dialog.add("csdnvideoDialog",function(f){function q(){var a=window.crypto||window.msCrypto,b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),d=b.length;Uint32Array.prototype.cl_map=function(a){for(var b=0,c=this.length,d=Array(c);b<c;b++)d[b]=a(this[b],b,this);return d};var c=new Uint32Array(8);a.getRandomValues(c);return c.cl_map(function(a){return b[a%d]}).join("")}function r(a,b){for(var d="",c=0;c<a.length;c++)var l=
a[c],d=d+('\x3cdiv class\x3d"video-item-box"\x3e  \x3cdiv class\x3d"radio-box"\x3e    \x3clabel\x3e      \x3cinput type\x3d"radio" name\x3d"rdoVideo" value\x3d"'+(b?b:c)+'"\x3e      \x3cspan class\x3d"radio-inner"\x3e\x3c/span\x3e    \x3c/label\x3e  \x3c/div\x3e  \x3cdiv class\x3d"title"\x3e'+l.title+'\x3c/div\x3e  \x3cdiv class\x3d"date"\x3e'+l.updateTime+"\x3c/div\x3e\x3c/div\x3e");return d}function t(a,b){a.setHtml('\x3cdiv class\x3d"nodata"\x3e  \x3cimg src\x3d"'+f.plugins.csdnvideo.path+'icons/nodata.png" width\x3d"1000px" height\x3d"100px"/\x3e  \x3cp class\x3d"nodata-txt"\x3e暂无视频内容，\x3ca class\x3d"btn-upload-video"\x3e去上传\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e');
a.findOne(".btn-upload-video").once("click",function(){window.open(f.config.csdnvideo.appendVideoUrl,"_blank");b.hide()})}function u(a){k=!0;f.config.csdnvideo.getVideoData(e).then(function(b){var d=a.findOne(".no-more-box");if(200===b.code&&0<b.data.data.length){var c=h.length;h=h.concat(b.data.data);for(var l=b.data.data,m=0;m<l.length;m++){var p=r([l[m]],c+m),p=CKEDITOR.dom.element.createFromHtml(p);p.insertBefore(d)}b.data.totalPages===e?(d.setStyle("display","block"),a.removeAllListeners()):
e+=1;k=!1}})["catch"](function(){k=!1})}var v=function(){var a=function(a,d){d=d||{};return CKEDITOR.tools.extend({id:"goUploadVideo",type:"button",label:"去上传","class":"btn-upload-video bottom",onClick:function(c){c=c.data.dialog;window.open(a.config.csdnvideo.appendVideoUrl,"_blank");c.hide()}},d,!0)};a.type="button";a.override=function(b){return CKEDITOR.tools.extend(function(d){return a(d,b)},{type:"button"},!0)};return a}();return{allowedContent:"div(csdn-data-video)[data-*];img[src,data-cke-widget-wrapper];p",
title:"插入视频",minWidth:552,minHeight:100,resizable:CKEDITOR.DIALOG_RESIZE_NONE,buttons:[v,CKEDITOR.dialog.okButton,CKEDITOR.dialog.cancelButton],contents:[{id:"csdnvideo",label:"插入视频URL",elements:[{type:"text",label:"视频URL",labelLayout:"horizontal",width:"472px",id:"csdnvideo-URL",validate:function(){if("videolist"===g)return!0;if(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/.test(this.getValue())){var a;a=this.getValue();a=CKEDITOR.ajax.load("https://blog-console-api.csdn.net/v1/video/linkConversion?url\x3d"+
a);a=JSON.parse(a);if(200===a.code)return this.result=a,!0;alert(a.msg);return!1}alert("请输入正确的视频URL");return!1},commit:function(a){var b;if("csdnvideo"===g){b=this.result;b=b.data;var d=b.cover_img||"https://img-blog.csdnimg.cn/editor-video.png",c=q()+"-"+Date.now();a.setData("cover_img",d);a.setData("player_url",b.player_url);a.setData("provider",b.provider);a.setData("title",b.title)}else b=document.querySelector('input[name\x3d"rdoVideo"]:checked').value,b=h[b],d=b.cover||"https://img-blog.csdnimg.cn/editor-video.png",
c=q()+"-"+Date.now(),a.setData("cover_img",d),a.setData("player_url","https://live.csdn.net/v/embed/"+b.id),a.setData("title",b.title),a.setData("provider","csdn");a.setData("id",c)}},{type:"html",html:'\x3cp style\x3d"color: #999; margin: 16px 0  0 76px"\x3e\x3cspan style\x3d"font-size: 30px;vertical-align: -6px;color: #999;"\x3e⋆\x3c/span\x3e目前仅支持哔哩哔哩视频、优酷视频\x3c/p\x3e'}]},{id:"videolist",label:"插入已有视频",elements:[{type:"html",id:"videoListBox",html:'\x3cdiv class\x3d"video-list-box"\x3e\x3ca class\x3d""\x3e\x3c/a\x3e\x3c/div\x3e',
validate:function(){if("csdnvideo"===g)return!0;if("videolist"===g)return null===document.querySelector('input[name\x3d"rdoVideo"]:checked')?(alert("请选择视频"),!1):!0}}]}],onShow:function(a){function b(a){a=a.data.getTarget();if(a.hasClass("cke_dialog_tab"))if(a=a.$.id,g=a=a.substring(4,a.lastIndexOf("_")),"videolist"===a){e=1;n=k=!1;console.log("dialog",d);var b=d._.contents[a].videoListBox.getElement();b.$.scrollTo(0,0);d.parts.footer.findOne("a.btn-upload-video.bottom").setStyle("display","block");
f.config.csdnvideo.getVideoData(e).then(function(a){if(200===a.code&&0<a.data.data.length){h=a.data.data;var c;c='\x3cdiv class\x3d"video-item-box top-title"\x3e  \x3cdiv class\x3d"radio-box"\x3e\x3c/div\x3e  \x3cdiv class\x3d"title"\x3e视频标题\x3c/div\x3e  \x3cdiv class\x3d"date"\x3e上传时间\x3c/div\x3e\x3c/div\x3e'+r(a.data.data);b.setHtml(c);b.appendHtml('\x3cdiv class\x3d"no-more-box"\x3e没有更多内容\x3c/div\x3e');a.data.totalPages===e?b.findOne(".no-more-box").setStyle("display","block"):(e+=1,b.on("scroll",
function(){b.$.scrollTop>=b.$.scrollHeight-b.$.offsetHeight-20&&!k&&u(b)}))}else t(b,d)})["catch"](function(){t(b,d)})}else d.parts.footer.findOne("a.btn-upload-video.bottom").setStyle("display","none")}e=1;g="csdnvideo";var d=this;a=f.getSelection().getStartElement();var c;n||(this.parts.tabs.removeListener("click",b),this.parts.tabs.on("click",b),n=!0);a&&(c=a.getAscendant("div",!0));c&&"div"==c.getName()&&"csdn-data-video"==c.getAttribute("class")?this.insertMode=!1:(c=f.document.createElement("div"),
c.addClass("csdn-data-video"),a=f.document.createElement("img"),a.isEditable=!1,c.append(a),a=f.document.createElement("p"),a.isEditable=!1,c.append(a),c.isEditable=!1,this.insertMode=!0);this.element=c;this.setupContent(this.element)},onHide:function(a){this.parts.footer.findOne("a.btn-upload-video.bottom").setStyle("display","none")}}})})();